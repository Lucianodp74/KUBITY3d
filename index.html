<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D Viewer – Demo GitHub Pages</title>
  <style>
    :root { --bg:#0e1116; --panel:#171b22; --text:#e8e8e8; --muted:#9aa4b2; --accent:#4da3ff; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { padding: 12px 16px; background: var(--panel); border-bottom: 1px solid #222831; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 16px; margin: 0 12px 0 0; font-weight: 600; letter-spacing: .2px; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .controls input[type="file"] { display: none; }
    .btn, .input, .link {
      border: 1px solid #2a3140; background: #11151b; color: var(--text);
      padding: 8px 10px; border-radius: 8px; font-size: 14px;
    }
    .btn { cursor: pointer; }
    .btn:hover { border-color: var(--accent); }
    .input { width: min(420px, 70vw); }
    .hint { color: var(--muted); font-size: 12px; }
    #viewer { position: relative; height: 100%; }
    #dropzone {
      position: absolute; inset: 0; border: 2px dashed #2a3140; border-radius: 12px;
      display: grid; place-items: center; text-align: center; padding: 24px; pointer-events: none; transition: border-color .2s, background .2s;
    }
    #dropzone.active { border-color: var(--accent); background: rgba(77,163,255,0.05); }
    #overlay { position:absolute; left:12px; bottom:12px; background: rgba(0,0,0,.45); padding:8px 10px; border-radius:8px; font-size:12px; color:#eaecef; }
    a { color: var(--accent); text-decoration: none; }
    .kbd { padding:1px 6px; border:1px solid #2a3140; border-bottom-width:2px; border-radius:6px; background:#0b0e13; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>3D Viewer</h1>
    <div class="controls">
      <label for="file" class="btn">Carica file (.glb/.gltf)</label>
      <input id="file" type="file" accept=".glb,.gltf,model/gltf-binary,model/gltf+json" />
      <input id="urlInput" class="input" type="url" placeholder="Incolla URL .glb/.gltf (anche del tuo repo)" />
      <button id="loadUrlBtn" class="btn">Apri URL</button>
      <span class="hint">Suggerimento: puoi anche trascinare un file nella finestra</span>
    </div>
  </header>

  <div id="viewer">
    <div id="dropzone">
      <div>
        <div style="font-weight:600; margin-bottom:6px;">Trascina qui un file .glb / .gltf</div>
        <div class="hint">Oppure usa “Carica file” o incolla un URL</div>
      </div>
    </div>
    <div id="overlay">
      <div><span class="kbd">tasto sinistro</span> ruota • <span class="kbd">rotellina</span> zoom • <span class="kbd">tasto destro</span> pan</div>
    </div>
  </div>
</div>

<!-- Usa moduli ES dal CDN (Three.js + loaders + controls) -->
<script type="module">
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js";
  import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/controls/OrbitControls.js";
  import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/loaders/GLTFLoader.js";
  import { DRACOLoader } from "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/loaders/DRACOLoader.js";

  // --- Setup renderer, scene, camera ---
  const container = document.getElementById("viewer");
  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  container.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  scene.background = null; // trasparente, si vede lo sfondo scuro del layout

  const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.01, 5000);
  camera.position.set(2.5, 1.8, 3.2);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // Luci “neutre”
  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dir = new THREE.DirectionalLight(0xffffff, 1.0);
  dir.position.set(5, 10, 7);
  scene.add(dir);

  // Piano/griglia opzionale per contesto
  const grid = new THREE.GridHelper(10, 10);
  grid.material.opacity = 0.2; grid.material.transparent = true;
  scene.add(grid);

  // Loader GLTF + DRACO (per modelli compressi)
  const gltfLoader = new GLTFLoader();
  const draco = new DRACOLoader();
  draco.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/libs/draco/");
  gltfLoader.setDRACOLoader(draco);

  // UI
  const fileInput = document.getElementById("file");
  const urlInput = document.getElementById("urlInput");
  const loadUrlBtn = document.getElementById("loadUrlBtn");
  const dropzone = document.getElementById("dropzone");

  let currentRoot = null;

  function clearScenePreviousModel() {
    if (!currentRoot) return;
    scene.remove(currentRoot);
    currentRoot.traverse(obj => {
      if (obj.geometry) obj.geometry.dispose();
      if (obj.material) {
        if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
        else obj.material.dispose();
      }
      if (obj.texture) obj.texture.dispose?.();
    });
    currentRoot = null;
  }

  function frameObject(object3D) {
    const box = new THREE.Box3().setFromObject(object3D);
    const size = box.getSize(new THREE.Vector3());
    const center = box.getCenter(new THREE.Vector3());

    // Posiziona il target dei controls al centro del modello
    controls.target.copy(center);

    // Calcola distanza camera per inquadrare l’oggetto
    const maxDim = Math.max(size.x, size.y, size.z);
    const fov = camera.fov * (Math.PI / 180);
    let cameraZ = Math.abs(maxDim / (2 * Math.tan(fov / 2)));

    cameraZ *= 1.5; // margine
    camera.position.set(center.x + cameraZ * 0.4, center.y + cameraZ * 0.4, center.z + cameraZ);
    camera.near = cameraZ / 100;
    camera.far = cameraZ * 100;
    camera.updateProjectionMatrix();
    controls.update();
  }

  async function loadFromUrl(url) {
    try {
      const isSameOrigin = new URL(url, location.href).origin === location.origin;
      // Con GitHub Pages è meglio usare file nello stesso dominio (repo) per evitare CORS
      const src = url;
      clearScenePreviousModel();
      const { scene: gltfScene } = await gltfLoader.loadAsync(src);
      currentRoot = gltfScene;
      scene.add(gltfScene);
      frameObject(gltfScene);
      dropzone.classList.remove("active");
    } catch (e) {
      alert("Errore nel caricamento dal URL. Verifica che il file sia accessibile (CORS) e che l’URL sia corretto.");
      console.error(e);
    }
  }

  async function loadFromFile(file) {
    if (!file) return;
    const url = URL.createObjectURL(file);
    try {
      clearScenePreviousModel();
      const { scene: gltfScene } = await gltfLoader.loadAsync(url);
      currentRoot = gltfScene;
      scene.add(gltfScene);
      frameObject(gltfScene);
    } catch (e) {
      alert("Errore nel caricamento del file. Verifica che sia un .glb/.gltf valido.");
      console.error(e);
    } finally {
      // rilascia l’URL quando non serve più (dopo il frame successivo per sicurezza)
      setTimeout(() => URL.revokeObjectURL(url), 10000);
    }
  }

  // Eventi UI
  document.querySelector('label[for="file"]').addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", (e) => loadFromFile(e.target.files[0]));
  loadUrlBtn.addEventListener("click", () => {
    if (urlInput.value.trim()) loadFromUrl(urlInput.value.trim());
  });
  urlInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && urlInput.value.trim()) loadFromUrl(urlInput.value.trim());
  });

  // Drag & drop
  window.addEventListener("dragover", (e) => { e.preventDefault(); dropzone.classList.add("active"); });
  window.addEventListener("dragleave", () => dropzone.classList.remove("active"));
  window.addEventListener("drop", (e) => {
    e.preventDefault();
    dropzone.classList.remove("active");
    const file = e.dataTransfer.files?.[0];
    if (file) loadFromFile(file);
  });

  // Caricamento tramite query string ?model=percorso/nel/repo.glb
  const params = new URLSearchParams(location.search);
  const qsModel = params.get("model");
  if (qsModel) {
    // Esempio: https://tuonome.github.io/tuo-repo/index.html?model=assets/modello.glb
    loadFromUrl(qsModel);
  }

  // Resize
  function onResize() {
    const { clientWidth:w, clientHeight:h } = container;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h);
  }
  window.addEventListener("resize", onResize);
  onResize();

  // Loop
  renderer.setAnimationLoop(() => {
    controls.update();
    renderer.render(scene, camera);
  });
</script>
</body>
</html>
